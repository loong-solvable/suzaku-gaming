# Suzaku Gaming 完整项目补全规划方案（企业级）

## 0. 文档信息
- 文档版本：v1.0
- 生成日期：2026-02-04
- 适用范围：`suzaku-gaming-admin` 前端复刻项目 + 新增后端与数据接入体系
- 目标受众：资深软件工程师、技术负责人
- 依赖文档：`Suzaku_Gaming_Ultimate_Implementation_Plan.md`、`Visual_Spec_and_Tokens.md`、`Test_Plan_and_Cases.md`、`Traceability_Matrix.md`、`Decision_Log.md`、`补全计划/DATA_INTEGRATION_PLAN.md`、`补全计划/数据接入与后端规划报告.md`

## 1. 当前项目基线（基于仓库实际状态）
### 1.1 已具备内容
- 前端主体页面已存在：Dashboard、角色列表、订单列表、绑定申请、新增归因更改。
- 公共组件已存在：`FilterBar`、`DataTable`、`ImageUpload`。
- 设计 Token 与全局样式体系已存在：`src/assets/styles/*`。
- 基础工具已存在：`src/utils/request.ts`、`src/utils/export.ts`、`src/utils/format.ts`。

### 1.2 关键缺失（影响可运行与交付）
- 缺少 `src/layouts/MainLayout.vue`，导致路由入口不可用。
- 缺少 `src/components/common/StatCard/index.vue`，导致 Dashboard 不可构建。
- 缺少 `src/stores` 目录及 `app/user` store，导致 Header/Sidebar 引用失败。
- Mock 仅包含 dashboard，角色/订单/审核接口缺失，页面数据仍为本地模拟。
- API 契约在多个文档之间不一致，前端页面仍使用 `fetch` 与局部假数据。
- 无测试用例、无 README、无 CI/CD。

### 1.3 结论
当前仓库处于“UI 原型 + 部分功能展示”的阶段，距离“企业级可交付完整体”尚有结构性缺口。补全计划需以“先可运行、再可测试、再可交付”为主线逐层推进。

## 2. 目标完整体定义（企业级可交付）
### 2.1 最终形态
- 前端：100% 对齐视觉规范 + 真实 API 驱动 + 完整交互闭环 + 可靠错误处理。
- 后端：可用的 REST API + 权限控制 + 稳定的数据查询性能。
- 数据：CSV 增量接入 + 去重 + 汇总统计 + 可追溯审计。
- 质量：Lint/TypeCheck/Unit/E2E/视觉回归全部通过。
- 运维：日志、监控、告警、备份、部署流程齐备。

### 2.2 统一验收口径
- UI 还原：像素误差 ≤1px，遵循 `Visual_Spec_and_Tokens.md`。
- 功能覆盖：对照 `Traceability_Matrix.md` 逐项通过。
- 性能：FCP ≤1.5s，LCP ≤2.5s，构建体积 ≤500KB(gzip)。
- 稳定性：核心页面 API 99% 成功率，ETL 具备幂等与重试。

## 3. 统一契约与口径（必须先锁定）
### 3.1 API 基础规范
- 通用响应结构：`{ code: 0, message: 'success', data: ..., timestamp: number }`
- 统一分页结构：`data.list` + `data.pagination`。
- 所有 ID 字段一律使用字符串，避免 JS 精度问题。
- 所有时间字段一律使用 UTC 或明确时区，并在响应中注明时区（默认 UTC+0，前端按本地格式化）。

### 3.2 统一接口清单（以当前前端路径为准）
- `GET /api/dashboard/statistics`
- `GET /api/player/roles`
- `GET /api/player/orders`
- `GET /api/audit/binding-applies`
- `POST /api/audit/binding-applies`
- `PUT /api/audit/binding-applies/:id`
- `DELETE /api/audit/binding-applies/:id`

### 3.3 角色数据字段口径
- `roleId`: CSV `role_id`
- `roleName`: CSV `role_name`
- `serverId`: CSV `server_id`
- `serverName`: CSV `server_name`
- `level`: CSV `role_level`
- `vipLevel`: CSV `vip_level`
- `totalRecharge`: CSV `total_recharge_usd`
- `totalRechargeTimes`: CSV `total_recharge_times`
- `registerTime`: CSV `#event_time`
- `lastLoginTime`: 若无登录日志，先定义为 `registerTime` 或 ETL 取最新事件时间，后续可接入登录事件数据源更新
- `status`: 规则先统一为 `active`，后续通过业务规则或登录事件进行活跃/封禁判定
- `channelId`: CSV `channel_id`
- `deviceType`: CSV `dev_type`
- `country`: CSV `#country`

### 3.4 订单数据字段口径
- `orderId`: CSV `game_order_id`
- `roleId`: CSV `role_id`
- `roleName`: CSV `role_name`
- `amount`: CSV `pay_amount_usd`
- `currency`: CSV `currency_type`
- `payTime`: 优先 CSV `order_confirm_time`，回退 `#event_time`
- `orderType`: 优先 CSV `recharge_type`，无则默认 `recharge`
- `status`: `success` 当 `order_confirm_time` 存在且 `is_sandbox=0`，其他情况映射为 `pending/failed`
- `channel`: CSV `recharge_channel`，无则用 `channel_id`

### 3.5 Dashboard 指标口径
- `paidAmount` 为统一字段名，与前端一致。
- 活跃玩家口径必须明确。建议：有登录事件视为活跃，若暂缺登录事件，使用当日有充值记录作为临时口径，并在文档中标注“临时口径”。

## 4. 分阶段实施路线（每阶段必须测试通过才进入下一阶段）

### 阶段 0：需求冻结与基线清理
目标：统一口径与范围，冻结接口与字段标准。

执行项：
1. 统一接口路径与字段命名，以本方案为唯一标准。
2. 合并文档冲突点，更新 `Decision_Log.md`。
3. 确认不在范围内的功能（如权限 UI 仅展示或真实实现）。
4. 生成最终 “接口契约说明” 文档并锁定版本。

验收：
1. 所有接口、字段、口径均在文档中明确。
2. `Decision_Log.md` 记录所有冲突裁决。

### 阶段 1：前端可运行修复（P0）
目标：解决当前无法构建的问题，保证 `pnpm dev` 可运行。

执行项：
1. 新建 `src/layouts/MainLayout.vue`，组装 Header、Sidebar 与主内容区。
2. 新建 `src/components/common/StatCard/index.vue`，匹配 Dashboard 卡片视觉。
3. 新建 `src/stores/app.ts` 与 `src/stores/user.ts`，并添加 `src/stores/index.ts`。
4. 统一路由入口，删除或合并 `src/router/routes.ts` 的冗余配置。

验收：
1. `pnpm dev` 可启动且页面可正常访问。
2. `pnpm type-check` 通过。

### 阶段 2：前端功能完备与契约对齐（P0）
目标：全部页面以统一 API 契约工作。

执行项：
1. 新建 `src/api` 目录，提供 Dashboard/Player/Audit API 模块。
2. 替换页面中的 `fetch` 或本地 mock，统一使用 `request`。
3. 将分页结构统一为 `data.pagination`，修正所有页面对 `total` 的读取方式。
4. 使用 `exportCSV` 补齐导出逻辑。

验收：
1. 角色/订单/审核页面可以在 Mock 模式下通过 API 模块取数。
2. 所有表格分页、排序、过滤逻辑一致。
3. `pnpm lint` 与 `pnpm type-check` 通过。

### 阶段 3：Mock 体系完善（P0）
目标：全量模拟后端接口，支持前端独立验收。

执行项：
1. 新增 `src/mock/player.ts`、`src/mock/audit.ts`。
2. Mock 数据严格遵循接口契约，支持分页与过滤逻辑。
3. Mock 数据固定种子，保证 E2E 稳定性。

验收：
1. Mock 模式下所有页面数据可正常展示。
2. 数据分页、过滤、排序可复现。

### 阶段 4：后端基础服务搭建（P0）
目标：建立生产级后端项目骨架。

执行项：
1. 新建后端目录（建议 `suzaku-gaming-admin-server`）。
2. 技术栈建议：NestJS + PostgreSQL + Prisma + Redis。
3. 基础模块：`auth`、`player`、`order`、`audit`、`dashboard`、`health`。
4. 接入 Swagger/OpenAPI 文档输出。

验收：
1. `/health` 可用，Swagger 可访问。
2. 所有接口返回结构符合统一契约。

### 阶段 5：数据库与数据接入（P0）
目标：具备真实数据入库与查询能力。

执行项：
1. 设计 `roles`、`orders`、`daily_stats` 核心表。
2. 实现 CSV ETL 脚本（Node.js 或 Python）。
3. 实现去重、幂等、增量导入。
4. 导入后生成基础统计数据。

验收：
1. CSV 可导入并可查询。
2. 同一 CSV 可重复导入不产生重复数据。
3. Dashboard 指标可基于数据库实时输出。

### 阶段 6：安全、权限与审计（P1）
目标：达到企业级访问控制。

执行项：
1. 增加 JWT 登录与 RBAC 权限控制。
2. API 接口按角色授权。
3. 订单/角色敏感字段脱敏输出。
4. 审计日志落库与检索。

验收：
1. 未授权访问返回 401/403。
2. 审计日志可检索并可追踪操作人。

### 阶段 7：性能与可观测性（P1）
目标：保证生产稳定性。

执行项：
1. 数据库索引优化与查询分析。
2. Redis 缓存 Dashboard 聚合结果。
3. 接入日志系统、指标监控、告警。
4. 错误追踪（Sentry 或自建）。

验收：
1. 典型列表页响应 < 500ms。
2. Dashboard 统计接口 < 300ms。
3. 关键指标有监控告警。

### 阶段 8：测试与交付（P0）
目标：满足企业级交付门槛。

执行项：
1. 补齐单元测试、组件测试、E2E 测试。
2. 补齐视觉回归用例与基准截图。
3. 建立 CI/CD 流水线。
4. 编写 README、部署文档、回滚策略。

验收：
1. `pnpm test:coverage` ≥ 80%。
2. `pnpm test:e2e` 100% 通过。
3. `pnpm test:visual` 无差异。
4. `pnpm build` 无警告。

## 5. 数据库与后端设计（核心草案）
### 5.1 核心表
- `roles`：角色基础数据，主键 `role_id`。
- `orders`：订单数据，主键 `order_id`。
- `daily_stats`：每日统计快照。
- `users`：后台管理用户。
- `roles_permissions`：权限关系表。
- `audit_logs`：操作审计表。

### 5.2 关键索引
- `roles(role_id)` 唯一索引
- `orders(order_id)` 唯一索引
- `orders(role_id)`、`orders(pay_time)`、`orders(channel_id)`
- `roles(server_id)`、`roles(country_code)`

## 6. 接口响应示例（统一标准）
### 6.1 角色列表响应
```
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "roleId": "9000310004564",
        "roleName": "玩家A",
        "serverId": "31",
        "serverName": "S31",
        "level": 1,
        "vipLevel": 0,
        "totalRecharge": 0,
        "status": "active",
        "registerTime": "2026-02-04T05:37:14Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "total": 500,
      "totalPages": 50
    }
  },
  "timestamp": 1738640000000
}
```

### 6.2 Dashboard 响应
```
{
  "code": 0,
  "message": "success",
  "data": {
    "today": { "newPlayers": 0, "activePlayers": 0, "paidPlayers": 0, "paidAmount": 0 },
    "monthly": { "newPlayers": 0, "activePlayers": 0, "paidPlayers": 0, "paidAmount": 0 },
    "total": { "newPlayers": 0, "activePlayers": 0, "paidPlayers": 0, "paidAmount": 0 }
  },
  "timestamp": 1738640000000
}
```

## 7. 工程化与交付标准
### 7.1 代码质量
- ESLint、Stylelint、TypeScript 必须 0 error。
- 禁止残留 `console.log`。

### 7.2 CI/CD
- PR 必须通过 lint、type-check、unit、e2e、visual。
- 部署前生成变更记录与回滚包。

### 7.3 运维
- 日志：至少 INFO/WARN/ERROR 分级。
- 监控：请求耗时、错误率、队列积压。
- 备份：数据库每日快照，至少保留 7 天。

## 8. 风险与对策
- 风险：登录/活跃数据缺失导致统计不准。
- 对策：引入登录事件数据源或标注为临时口径。

- 风险：CSV 字段口径变化导致 ETL 失败。
- 对策：ETL 加入字段校验与版本控制。

- 风险：前后端字段命名不一致。
- 对策：接口契约冻结并纳入 CI 校验。

## 9. 输出物清单
- 可运行前端工程（UI 完整）。
- 可运行后端工程（API + 数据接入）。
- 完整的接口文档与数据字典。
- 测试报告与视觉回归基线。
- 部署与运维文档。

## 10. 最终交付标准
当以下条件全部满足，则视为“企业级完整体”交付成功。
1. 前端全量页面与交互符合视觉规范。
2. 后端真实数据可驱动全部页面。
3. 所有测试门禁全绿。
4. 监控与告警已部署。
5. 完整文档与交付包可用。
