# 海战CPS验收结果更改方案（仅方案，不改代码）

> 生成日期：2026-02-06  
> 适用仓库：`d:\code\suzaku\suzaku-cursor`  
> 说明：本文件基于当前代码现状评估，输出可执行的变更方案、冲突分析与分阶段测试闸门。当前阶段**不修改业务代码**。

## 0. 目标与边界

- 目标：将你提出的“问题1-7 + 新增用户创建逻辑 + 新的需求调整”整合为一套可落地、可验收、可回归的实施方案。
- 边界：本次仅输出设计与实施计划，不改动 `server/admin` 代码。
- 执行原则：每一阶段必须“测试全部通过”后，才进入下一阶段。

---

## 1. 代码现状核查结论（已实现/待实现）

| 项目 | 当前状态 | 结论 |
|---|---|---|
| 问题1：充值金额来源应使用 `pay_amount_usd` | 角色同步仍读取 `total_recharge_usd`（`thinkingdata.service.ts`），角色列表展示沿用角色表金额 | **未满足** |
| 问题2：保持不变 | 当前逻辑可继续沿用（不做改动） | **按要求保持不变** |
| 问题3：由“新的需求调整”解决 | 已有 `tf_medium` 检查能力（`cps.service.ts`），但未接入“归因申请前本地库校验 + 同步入库过滤”全流程 | **部分满足** |
| 问题4：归因申请界面从三级改二级结构 | `NewAttribution.vue` 仍是“一级平台/二级组长/三级组员” | **未满足** |
| 问题5：截图必传 3-5 张 | 前端仅限制最多 5 张，未强制最少 3 张；后端 DTO 未做 3-5 约束 | **未满足** |
| 问题6：项目写死为“海战” | `NewAttribution.vue` 仍可选多个项目 | **未满足** |
| 问题7：由“新的需求调整”解决 | 角色/订单列表当前直接查 `roles/orders`，未实现“审核通过后才显示” | **未满足** |
| 新增用户创建逻辑 | 已实现“组长只能创建组员、继承组编码”；未实现 A/B/C 初始组长、组员编号自动分配 | **部分满足** |
| 新需求：同步前过滤 + 入库不展示 + 申请校验 + 审核后展示 | 当前没有“同步过滤后仅入库不展示”的完整机制 | **未满足** |

---

## 2. 问题逐项方案（1-7）

## 2.1 问题1

### 问题
不应读取 `total_recharge_usd`，应使用事件明细中的 `pay_amount_usd` 口径。

### 问题原因
- 角色同步 SQL 直接取 `ta.v_user_22.total_recharge_usd`。
- 该值是上游聚合字段，不满足你要求的“以事件金额为准”。

### 解决方法
- 停止在角色同步流程使用 `total_recharge_usd` 作为业务展示口径。
- 角色总充值改为由订单事件（`recharge_complete`）中的 `pay_amount_usd` 聚合得到。

### 具体实施步骤
1. 修改 `thinkingdata.service.ts` 的角色同步 SQL，不再依赖 `total_recharge_usd`。
2. 统一金额口径：在 `player.service.ts` 角色列表中，金额来自订单聚合（或由订单同步过程回写聚合值）。
3. 对齐导出逻辑，确保导出金额口径一致。

### 测试用例
- TC-P1-01：同一角色 3 笔订单金额分别 1/2/3，角色总金额应为 6。
- TC-P1-02：仅沙盒订单存在时，角色总金额应为 0（如业务定义排除沙盒）。
- TC-P1-03：角色列表金额与订单列表汇总金额一致。

---

## 2.2 问题2（保持不变）

### 问题
问题2按你的要求不做修改。

### 处理策略
- 显式标记为“冻结项”。
- 在回归阶段增加防回归用例，确认问题2相关行为未被连带改坏。

### 测试用例
- TC-P2-01：问题2对应页面/API行为与当前线上一致。
- TC-P2-02：执行完所有其他改动后，问题2结果无变化。

---

## 2.3 问题3（由“新的需求调整”解决）

### 问题
归因申请时缺少符合你新规则的准入校验链路。

### 问题原因
- 当前已有 `tf_medium` 检查能力，但主要在 CPS 绑定流程使用。
- 归因申请创建未校验“角色ID是否已在本地可绑定池”。

### 解决方法
按“新的需求调整”重构为：
- 同步阶段先过滤可绑定用户入本地库。
- 申请阶段只允许提交本地库已存在角色。
- 不满足条件时报错并记录失败日志。

### 具体实施步骤
1. 在同步 SQL 增加 `tf_medium` 过滤条件，仅拉取 Organic/自然量/WA_CPS_link%。
2. 新增归因申请创建前的角色存在性校验（查本地库）。
3. 校验失败写入失败日志（可复用 `cps_bind_fail_logs` 或新增专表）。

### 测试用例
- TC-P3-01：买量角色不入本地可绑定池。
- TC-P3-02：提交不存在角色ID，接口返回错误并阻断提交。
- TC-P3-03：提交存在角色ID，申请可创建成功。
- TC-P3-04：失败日志中记录操作人、角色ID、失败原因。

---

## 2.4 问题4

### 问题
归因申请界面需从“一级平台/二级组长/三级组员”改为“组名 + 组员编号”二级架构。

### 问题原因
- 前端仍使用旧三级结构。
- `team-options` 接口目前返回全量组长/组员，未按“组名/组员编号”组织和隔离。

### 解决方法
- 前端表单重构为二级联动：`组名` -> `组员编号`。
- 组名从已存在分组中选择；组员编号从该组现有成员中选择。

### 具体实施步骤
1. `NewAttribution.vue` 移除三级字段控件，替换为组名与组员编号。
2. `user.service.ts` 调整 `getTeamOptions`，按当前登录人角色做数据隔离。
3. 后端保存时，字段语义统一（建议：`platform` 暂存组名，`teamMember` 暂存组员编号，后续可做字段重命名迁移）。

### 测试用例
- TC-P4-01：组名下拉只出现系统已存在组名。
- TC-P4-02：选中 A 组后，组员编号下拉仅出现 A 组组员编号。
- TC-P4-03：组员账号发起申请时，只能看到本组组名与本组组员编号。

---

## 2.5 问题5

### 问题
截图上传必须是必填，且数量范围 3-5 张。

### 问题原因
- 前端只做了“最多 5 张”。
- 后端 DTO 未做最小/最大数量校验，存在绕过前端提交风险。

### 解决方法
- 前后端双重校验 3-5 张。

### 具体实施步骤
1. 前端提交前校验成功上传数必须在 3-5。
2. 后端 `CreateBindingApplyDto` 增加数组最小/最大长度校验。
3. 审核/编辑场景保持一致校验规则。

### 测试用例
- TC-P5-01：上传 2 张提交失败。
- TC-P5-02：上传 3 张提交成功。
- TC-P5-03：上传 6 张被拒绝。
- TC-P5-04：绕过前端直接调 API 传 0/2/6 张，后端仍拒绝。

---

## 2.6 问题6

### 问题
“修改归因申请”界面里“项目选择”改为“项目”，并写死为“海战”。

### 问题原因
- 前端仍存在多个项目选项。
- 后端创建申请时接受任意 `project`，可被篡改。

### 解决方法
- UI 固定显示“项目：海战”。
- 后端强制写入 `project='海战'`，忽略外部传入值。

### 具体实施步骤
1. `NewAttribution.vue` 将“项目选择”改为只读“项目”。
2. `audit.service.ts` 创建申请时强制覆盖 `project`。
3. `BindingApplyFilter.vue` 项目筛选收敛为“海战”单值。

### 测试用例
- TC-P6-01：页面显示“项目：海战”，不可改。
- TC-P6-02：接口传入 `project=JUR`，数据库仍保存“海战”。

---

## 2.7 问题7（由“新的需求调整”解决）

### 问题
角色列表/订单列表必须只展示“审核 -> 绑定申请”状态为“审核通过”的角色及其订单。

### 问题原因
- 当前列表直接读取 `roles/orders`，无审核状态准入过滤。

### 解决方法
- 引入“展示准入标记”（建议 `roles.cpsVisible`，默认 `false`）。
- 仅审核通过时将对应角色标记为可见。
- 角色/订单查询统一按可见标记过滤。

### 具体实施步骤
1. 扩展角色可见性字段（或等效机制）。
2. `reviewBindingApply` 在 `approve` 分支写入可见状态。
3. `player.service.ts` 的角色/订单列表和导出统一加过滤。

### 测试用例
- TC-P7-01：同步完成但未审核通过，角色/订单列表为空或不含该角色。
- TC-P7-02：审核通过后，该角色及其订单出现在列表。
- TC-P7-03：审核拒绝后，仍不可见。

---

## 3. 新增用户创建逻辑改造方案

### 需求重述（结构化）
- 初始必须有：管理员账号 + A/B/C 三个组 + 每组组长账号。
- 组长只能创建本组组员。
- 创建组员时自动分配“组员编号”并展示。
- 组员归因申请时，“来源更改为 -> 组员”只能选本组已有组员编号。
- 管理员可对任何组、任何账号执行创建与修改。

### 当前状态
- 已有：组长只能创建组员、组信息继承。
- 缺失：A/B/C 初始组长、组员编号自动生成、组员编号在归因页面可选。

### 解决方法
- 数据模型补齐组员编号字段（建议 `admin_users.member_code`）。
- seed/bootstrap 改造为“仅初始化账号与分组，不注入示例业务数据”。

### 具体实施步骤
1. `schema.prisma` 为 `AdminUser` 增加 `memberCode`（组内唯一约束建议与组编码组合唯一）。
2. `seed.ts` 初始化 `admin + leaderA + leaderB + leaderC`，分别绑定 `A/B/C`。
3. `user.service.ts/createUser`：组长创建组员时自动生成编号（如 `A-001`）。
4. 前端用户管理页展示组员编号、创建成功提示返回编号。
5. `team-options` 返回结构调整为按组提供“组名 + 组员编号”。

### 测试用例
- TC-U1-01：首次初始化后存在 admin、A/B/C 组长。
- TC-U1-02：A组组长创建组员，编号自动生成 `A-001`。
- TC-U1-03：A组组长尝试创建 B 组组员被拒绝。
- TC-U1-04：管理员可创建/修改任意组账号。
- TC-U1-05：归因申请“组员编号”下拉只显示本组编号。

---

## 4. “新的需求调整”落地方案（核心流程）

## 4.1 目标流程

1. 系统初始部署时，业务数据表为空。  
2. 从数数平台同步时，先按 `tf_medium` 规则过滤。  
3. 过滤后数据先入库，但默认不在角色/订单列表展示。  
4. 操作者提交归因申请时，必须先校验角色ID在本地库存在。  
5. 仅审核通过后，将对应角色及订单放开展示。  

## 4.2 当前冲突点

- `prisma/seed.ts` 当前包含示例角色/订单/绑定申请，不符合“业务数据空库初始化”。
- `thinkingdata.service.ts` 同步没有按你给定 SQL 过滤 `tf_medium`。
- `player.service.ts` 列表未实现审核驱动展示。

## 4.3 落地策略

### 策略A（推荐，改动更可控）
- 保持 `roles/orders` 作为统一业务表。
- 增加“可见性”字段控制展示，不额外引入影子表。
- 审核通过驱动可见性变更。

### 关键SQL对齐
- 在角色同步 SQL 中加入：
  - `tf_medium='Organic'`
  - `tf_medium like '%自然量%'`
  - `tf_medium like 'WA_CPS_link%'`
- 订单同步需与可绑定账号集合关联（按 `#account_id` 过滤）以防混入买量订单。

### 申请校验与失败日志
- 创建归因申请前校验 `roleId` 是否存在本地可绑定池。
- 不存在时返回明确错误并记录失败日志。

### 测试用例
- TC-N2-01：同步仅写入符合 `tf_medium` 的账号。
- TC-N2-02：同步后列表默认不可见。
- TC-N2-03：不存在角色ID提交申请被拦截并记日志。
- TC-N2-04：审核通过后角色/订单变为可见。

---

## 5. 变更冲突与相互影响分析

| 冲突点 | 风险 | 处理策略 |
|---|---|---|
| “数据库空”与“必须有初始管理员/组长”看似矛盾 | 可能误解为所有表都空，导致无登录账号 | 明确定义：业务数据表空；账号与组织表初始化 |
| 三级结构改二级结构与历史申请数据兼容 | 历史数据可能是旧字段语义 | 采用兼容映射：新申请按新语义，历史记录保留原值展示 |
| 金额口径切换可能影响统计口径 | 角色金额与历史导出不一致 | 统一以 `pay_amount_usd` 为准，并在回归中做对账测试 |
| 列表展示改为审核驱动 | 可能被误认为“同步失败” | 在管理页面增加状态提示：已入库待审核，不等于未同步 |
| 问题2不改与其他改动并行 | 连带回归风险 | 将问题2列为冻结项，单独回归验证 |

---

## 6. 分阶段执行顺序与测试闸门

> 规则：每个阶段测试全部通过后，才允许进入下一阶段。

## Phase 0：基线冻结与回归基线

### 目标
- 锁定当前行为，建立“问题2不改”的对照基线。

### 必过测试
- T0-01：问题2现状快照（页面/API）。
- T0-02：现有登录、权限、列表基本流程可用。

---

## Phase 1：数据模型与初始化改造（用户与组织）

### 改造范围
- `schema.prisma`
- `seed.ts`
- `user.service.ts`
- `user.controller.ts`
- 用户管理前端与 `userApi` 类型

### 必过测试
- T1-01：初始化后存在 admin + A/B/C 组长。
- T1-02：组长仅能创建本组组员。
- T1-03：组员编号自动生成且唯一。
- T1-04：管理员可跨组创建与修改。

---

## Phase 2：同步过滤与金额口径改造（问题1 + 新需求前半）

### 改造范围
- `thinkingdata.service.ts`
- `player.service.ts`
- 必要的同步脚本（若生产使用）

### 必过测试
- T2-01：`tf_medium` 过滤生效（只入可绑定池）。
- T2-02：角色金额口径来自 `pay_amount_usd` 聚合。
- T2-03：问题2行为不变。

---

## Phase 3：归因申请校验与审核驱动展示（问题3 + 问题7 + 新需求后半）

### 改造范围
- `audit.service.ts`
- `audit.dto`
- `player.service.ts`
- 失败日志落表逻辑

### 必过测试
- T3-01：角色ID不存在时申请失败并记录日志。
- T3-02：审核通过前角色/订单不可见。
- T3-03：审核通过后角色/订单可见。
- T3-04：审核拒绝不放开显示。

---

## Phase 4：前端表单与交互重构（问题4/5/6）

### 改造范围
- `NewAttribution.vue`
- `BindingApply.vue`
- `BindingApplyFilter.vue`
- `auditApi` / `userApi` 类型

### 必过测试
- T4-01：界面为“组名 + 组员编号”二级结构。
- T4-02：组员仅可选本组编号。
- T4-03：截图必须 3-5 张。
- T4-04：项目固定显示“海战”。

---

## Phase 5：全链路回归与发布验收

### 必过测试
- T5-01：端到端流程：同步 -> 申请 -> 审核 -> 列表展示。
- T5-02：冻结项（问题2）保持不变。
- T5-03：导出、分页、权限、日志均正常。

---

## 6.1 分层测试矩阵（每层必须通过）

| 层级 | Phase 1 | Phase 2 | Phase 3 | Phase 4 | Phase 5 |
|---|---|---|---|---|---|
| 数据库层（Schema/数据约束） | `member_code` 生成与唯一性 | `tf_medium` 过滤后入库结果 | 审核通过后可见性字段变化 | 截图数量入库约束生效 | 历史数据兼容与回归校验 |
| 服务层（Service/权限/业务规则） | 组长创建权限边界 | 金额聚合口径一致性 | 申请前角色校验与失败日志 | 固定项目与字段映射 | 问题2冻结项不回归 |
| 接口层（Controller/API） | 用户创建与查询接口 | 同步接口过滤结果 | 申请创建/审核接口状态流转 | 表单提交校验错误码与提示 | 导出/分页/筛选接口稳定 |
| 前端层（页面交互） | 用户管理展示编号 | 角色/订单金额展示一致 | 未审核数据不可见 | 二级结构、3-5截图、项目固定 | 全流程E2E |

### 阶段推进硬规则
- Rule-1：每个 Phase 的数据库层、服务层、接口层、前端层测试都必须全部通过。
- Rule-2：任一层存在阻塞缺陷（P1/P2级），禁止进入下一阶段。
- Rule-3：每个 Phase 完成后执行一次“问题2冻结项”回归抽检。

---

## 7. 具体改动文件清单（计划）

### 后端
- `suzaku-gaming-server/prisma/schema.prisma`
- `suzaku-gaming-server/prisma/seed.ts`
- `suzaku-gaming-server/src/modules/user/user.service.ts`
- `suzaku-gaming-server/src/modules/user/user.controller.ts`
- `suzaku-gaming-server/src/modules/thinkingdata/thinkingdata.service.ts`
- `suzaku-gaming-server/src/modules/audit/dto/create-binding-apply.dto.ts`
- `suzaku-gaming-server/src/modules/audit/audit.service.ts`
- `suzaku-gaming-server/src/modules/player/player.service.ts`

### 前端
- `suzaku-gaming-admin/src/views/Audit/NewAttribution.vue`
- `suzaku-gaming-admin/src/views/Audit/BindingApply.vue`
- `suzaku-gaming-admin/src/views/Audit/components/BindingApplyFilter.vue`
- `suzaku-gaming-admin/src/views/System/UserManagement.vue`
- `suzaku-gaming-admin/src/api/audit.ts`
- `suzaku-gaming-admin/src/api/user.ts`

### 测试
- 新增或更新后端服务单测、接口集成测试、前端 E2E（`new-attribution`、`binding-apply`、`role-list`、`order-list`）。

---

## 8. 验收口径（最终判定标准）

- 问题1、3、4、5、6、7 与两项新增需求全部闭环。
- 问题2保持不变并通过回归。
- 所有阶段测试通过且无跨阶段回归。
- 业务流程符合你定义：
  - 同步先过滤
  - 仅入库不直接展示
  - 申请前校验角色ID
  - 审核通过后才展示角色与订单

---

## 9. 备注

- 当前代码中已有可复用能力：
  - 组长创建组员权限控制（已存在）。
  - CPS 相关 `tf_medium` 判断与失败日志基础能力（已存在）。
  - CPS 充值/登录日志 SQL 与你给出的参考 SQL 基本同向（已存在）。
- 本方案优先在“最小破坏、可回归、可分阶段上线”前提下设计，避免一次性大改带来发布风险。
