# 海战CPS公会数据系统 — 0206验收问题修改方案

> **生成日期**: 2026-02-06  
> **项目**: suzaku-gaming (海战CPS公会数据/绑定系统)  
> **范围**: 7项验收问题 + 2项新增需求  
> **状态**: 待实施

---

## 目录

1. [文档概述](#1-文档概述)
2. [问题清单与分析](#2-问题清单与分析)
3. [新增需求分析](#3-新增需求分析)
4. [解决方案总体架构](#4-解决方案总体架构)
5. [冲突与影响分析](#5-冲突与影响分析)
6. [实施阶段规划](#6-实施阶段规划)
7. [数据迁移与回滚策略](#7-数据迁移与回滚策略)

---

## 1. 文档概述

本文档针对 0206 验收中发现的 7 项问题，以及后续补充的 2 项新增需求，制定统一的修改方案。所有变更按照依赖关系编排为 **5 个实施阶段**，每阶段附带测试用例，上一阶段测试全部通过后方可进入下一阶段。

### 1.1 变更分类总览

| 序号 | 来源 | 描述 | 严重度 | 处理方式 |
|------|------|------|--------|----------|
| P1 | 验收问题 | 角色列表金额不准确 | 高 | Phase 3 修改 |
| P2 | 验收问题 | 订单列表部分充值渠道显示"未知" | 高 | **不修改**（保持现状） |
| P3 | 验收问题 | 归因绑定缺少绑定判断逻辑 | 高 | Phase 3 + Phase 4 解决 |
| P4 | 验收问题 | 归因表单层级结构错误 | 高 | Phase 4 修改 |
| P5 | 验收问题 | 截图上传应为必选项 | 中 | Phase 4 修改 |
| P6 | 验收问题 | 项目选择应固定为"海战" | 中 | Phase 4 修改 |
| P7 | 验收问题 | 列表数据应仅展示已归因角色 | 高 | Phase 3 + Phase 5 解决 |
| N1 | 新增需求 | 用户管理与组织架构调整 | 高 | Phase 1 + Phase 2 |
| N2 | 新增需求 | 业务流程全链路调整 | 高 | Phase 3 + Phase 5 |

---

## 2. 问题清单与分析

### 2.1 P1：角色列表金额不准确（高）

**问题描述**：角色列表中显示的"总付费金额"与实际不符。

**问题原因**：
- 当前角色同步 SQL（`thinkingdata.service.ts` → `buildRoleSyncSQL`）从 ThinkingData 用户视图 `ta.v_user_22` 拉取预聚合字段 `total_recharge_usd`。
- 该字段为 ThinkingData 平台侧的预聚合值，可能存在统计口径差异或更新延迟。
- 前端直接展示该值，无币种说明。

**当前代码位置**：
- 后端：`suzaku-gaming-server/src/modules/thinkingdata/thinkingdata.service.ts` → `buildRoleSyncSQL()` 第 559 行
- 后端：`suzaku-gaming-server/src/modules/player/player.service.ts` → `getRoles()` 第 164 行
- 前端：`suzaku-gaming-admin/src/views/PlayerData/RoleList.vue` 第 24 行

**解决方法**：不再使用 ThinkingData 用户视图中的 `total_recharge_usd` 预聚合字段。改为从本地数据库 `orders` 表动态聚合 `pay_amount_usd` 字段，以确保金额与实际订单明细一致。

---

### 2.2 P2：订单列表部分充值渠道显示"未知"（高）

**问题描述**：订单列表中部分订单的"充值渠道"显示为"未知"。

**处理决定**：**保持现状，不做修改。**

**备注**：该问题属于上游数据源（ThinkingData `sdk_order_purchase` 事件）覆盖率问题，与 LEFT JOIN 匹配率有关。当前映射逻辑本身正确，"未知"反映的是源数据缺失。

---

### 2.3 P3：归因绑定缺少绑定判断逻辑（高）

**问题描述**：用户提交归因绑定申请时，系统缺少对角色是否可绑定的判断。

**问题原因**：
- 后端 `cps.service.ts` 已实现 `checkBinding()` 方法（调用 ThinkingData API 查询 `tf_medium`），但前端 `NewAttribution.vue` 提交时未调用该接口。
- 更根本的问题是：业务流程应在数据同步阶段进行 `tf_medium` 过滤，而非在绑定申请时实时查询。

**解决方法**：通过 **新增需求 N2**（业务流程全链路调整）统一解决——
1. 在数据同步阶段通过 `tf_medium` 条件过滤，仅将符合条件的角色拉取到本地数据库。
2. 归因申请时，验证角色 ID 是否存在于本地数据库。若不存在，说明该角色不满足 CPS 绑定条件（如买量用户），拒绝申请并提示。
3. 记录验证失败日志。

---

### 2.4 P4：归因表单层级结构错误（高）

**问题描述**：当前"归因修改申请"页面采用三级结构（一级平台 → 二级组长 → 三级组员），不符合业务需求。

**问题原因**：
- "一级平台"选项为 Google/Facebook/TikTok/Organic 等买量平台名称，与 CPS 业务无关。
- 业务实际需要的是两级选择：**CPS 组名 → 组员编号**。

**当前代码位置**：
- 前端：`suzaku-gaming-admin/src/views/Audit/NewAttribution.vue` 第 46-101 行（表单定义）、第 264-305 行（模板）
- 后端 DTO：`suzaku-gaming-server/src/modules/audit/dto/create-binding-apply.dto.ts`

**解决方法**：
1. 将表单结构从三级改为两级：
   - **组名**（原 `platform` 字段）：下拉选择，选项为系统中已有的 CPS 分组名称（如 A 组、B 组、C 组）。
   - **组员编号**（原 `teamMember` 字段）：下拉选择，选项为所选分组中已存在的组员编号。
2. 移除"一级平台"和"二级组长"选择控件。
3. 数据隔离：操作员（组员）只能选择本组的组名和组员编号；管理员可选择任意组。

---

### 2.5 P5：截图上传应为必选项（中）

**问题描述**：提交归因申请时，截图上传未设为必填。

**问题原因**：
- 表单校验规则（`NewAttribution.vue` 第 113-121 行）未包含 `attachments` 字段的必填校验。
- 提交逻辑（第 177-179 行）仅校验了上限（5 张），未校验下限。

**当前代码位置**：
- 前端：`suzaku-gaming-admin/src/views/Audit/NewAttribution.vue` 第 113-121 行（rules）、第 174-212 行（handleSubmit）

**解决方法**：
1. 在提交校验中增加截图数量最小值检查：**必须上传 3-5 张截图**。
2. 上传成功少于 3 张时，禁用提交按钮并给出提示。

---

### 2.6 P6：项目选择应固定为"海战"（中）

**问题描述**：项目选择下拉包含多个无关选项（JUR、战舰）。

**问题原因**：
- `NewAttribution.vue` 第 58-62 行硬编码了 `projectOptions` 数组，包含 3 个选项。

**当前代码位置**：
- 前端：`suzaku-gaming-admin/src/views/Audit/NewAttribution.vue` 第 58-62 行

**解决方法**：
1. 将"项目选择"标签改为"项目"。
2. 默认值固定为 `warship`（海战），显示文本为"海战"。
3. 移除下拉选择器，改为只读文本展示。

---

### 2.7 P7：列表数据应仅展示已归因角色（高）

**问题描述**：角色列表和订单列表展示了所有同步到本地数据库的数据，而非仅展示已完成归因绑定的角色及其订单。

**问题原因**：
- `player.service.ts` 的 `getRoles()` 和 `getOrders()` 查询时无任何 CPS 相关过滤条件，返回全部数据。
- 虽然 CPS 同步服务（`cps-sync.service.ts`）已正确过滤了 CPS 维度表中的数据，但主列表展示逻辑未关联此过滤。

**当前代码位置**：
- 后端：`suzaku-gaming-server/src/modules/player/player.service.ts` → `getRoles()`、`getOrders()`

**解决方法**：通过 **新增需求 N2** 统一解决——
1. 角色表新增 `cpsVisible` 字段（布尔值，默认 `false`）。
2. 当归因申请审核通过时，将对应角色的 `cpsVisible` 设为 `true`。
3. 角色列表和订单列表查询时，增加 `cpsVisible = true` 过滤条件。

---

## 3. 新增需求分析

### 3.1 N1：用户管理与组织架构调整

**需求描述**：

系统初始部署时，应自动创建以下账户与分组结构：

| 账户 | 角色 | 分组 | 权限 |
|------|------|------|------|
| admin | 管理员 (level=0) | — | 可管理所有组、所有账号 |
| leader_a | 组长 (level=1) | A组 | 管理 A 组组员 |
| leader_b | 组长 (level=1) | B组 | 管理 B 组组员 |
| leader_c | 组长 (level=1) | C组 | 管理 C 组组员 |

组员管理规则：
1. **组长**可在本组下创建组员账号。创建时系统**自动分配组员编号**（如 A-001、A-002），并在界面上显示。
2. **管理员**可创建任意组的账号、可修改任何组和账号。
3. **组员编号**在归因申请中作为选项供选择，组员只能选择本组已有的编号。

**当前项目状态**：
- `AdminUser` 模型已有 `level`、`parentId`、`cpsGroupCode` 字段——**组织架构基础已存在**。
- `seed.ts` 仅创建了 1 个管理员 + 1 个组长 + 1 个运营人员——**需扩展**。
- `user.service.ts` 已实现组长只能创建组员的权限控制——**基本满足，需增加自动编号**。
- `AdminUser` 模型**缺少 `memberCode` 字段**——需新增。

**解决方法**：
1. Schema 新增 `memberCode` 字段（`AdminUser` 模型）。
2. 更新 `seed.ts`，创建 admin + 3 组组长。
3. 修改 `user.service.ts` → `createUser()`，在创建组员时自动生成组员编号。
4. 前端用户管理界面展示组员编号。

---

### 3.2 N2：业务流程全链路调整

**需求描述**：

系统部署后的完整业务流程应为：

```
┌──────────────────┐     ┌────────────────────┐     ┌───────────────────┐
│ 1. 数据同步       │     │ 2. 归因修改申请      │     │ 3. 审核            │
│                  │     │                    │     │                   │
│ 从 ThinkingData   │     │ 操作员填写申请表     │     │ 管理员/组长审核     │
│ 拉取数据时，      │────▶│                    │────▶│                   │
│ 仅拉取满足        │     │ - 验证角色ID存在于   │     │ - 通过：角色+订单   │
│ tf_medium 条件    │     │   本地数据库        │     │   可在列表中展示   │
│ 的角色和订单      │     │ - 选择组名+组员编号  │     │ - 拒绝：数据不展示  │
│                  │     │ - 上传3-5张截图     │     │                   │
│ 数据入库但不展示  │     │ - 项目固定为"海战"   │     │                   │
└──────────────────┘     └────────────────────┘     └───────────────────┘
```

**关键规则**：

1. **数据同步过滤**：拉取角色数据时，增加以下 SQL 过滤条件，仅同步"自然量"或"CPS"来源的用户：
   ```sql
   WHERE (tf_medium = 'Organic' 
          OR tf_medium LIKE '%自然量%' 
          OR tf_medium LIKE 'WA_CPS_link%')
   ```
   ```
   SELECT "#account_id", "tf_medium" from ta.v_user_22 
  where (tf_medium ='Organic' or tf_medium like '%自然量%' or tf_medium like'WA_CPS_link%')
   ```

2. **数据默认不展示**：同步到本地数据库的角色和订单默认处于"不可见"状态，不在角色列表和订单列表中展示。

3. **归因申请验证**：操作员提交归因申请时，系统验证输入的角色 ID 是否存在于本地数据库中。若不存在（说明该角色不满足 `tf_medium` 条件，可能是买量用户），则拒绝申请并提示"该角色不在CPS候选池中，无法绑定"。同时记录验证失败日志。

4. **审核驱动展示**：仅当归因申请审核通过后，对应角色及其所有订单才在角色列表和订单列表中可见。

**当前项目状态**：
- 数据同步（`thinkingdata.service.ts`）**未设置 `tf_medium` 过滤**——需修改同步 SQL。
- 角色列表/订单列表（`player.service.ts`）**无可见性过滤**——需增加条件。
- 审核通过流程（`audit.service.ts` → `reviewBindingApply`）**仅更新状态，未触发角色可见性变更**——需增加联动逻辑。
- CPS 充值/登录日志同步（`cps-sync.service.ts`）**已正确通过 CPS 维度表过滤**——无需修改。

---

## 4. 解决方案总体架构

### 4.1 数据模型变更

```
AdminUser 表 (admin_users)
├── 新增: member_code VARCHAR(20)  — 组员编号，如 A-001
└── 现有字段保留不变

Role 表 (roles)
├── 新增: cps_visible BOOLEAN DEFAULT false  — 是否在列表中可见
├── 保留: total_recharge_usd  — 改为从 orders 表动态聚合
└── 现有字段保留不变

BindingApply 表 (binding_applies)
├── 字段用途调整: platform → 存储 CPS 组名
├── 字段用途调整: team_member → 存储组员编号
├── 字段保留: team_leader → 新提交时置空，兼容旧数据
└── 现有字段保留不变
```

### 4.2 API 变更

| 接口 | 变更类型 | 说明 |
|------|---------|------|
| `POST /audit/binding-applies` | 修改 | 提交前增加角色ID本地验证 |
| `POST /audit/binding-applies/:id/review` | 修改 | 审核通过时联动设置 `cpsVisible` |
| `GET /player/roles` | 修改 | 增加 `cpsVisible=true` 过滤；金额改为动态聚合 |
| `GET /player/orders` | 修改 | 增加关联角色 `cpsVisible=true` 过滤 |
| `POST /user/create` | 修改 | 创建组员时自动生成 `memberCode` |
| `GET /user/team-options` | 修改 | 返回数据增加 `memberCode` 和 `cpsGroupCode` |
| `GET /audit/role-check/:roleId` | **新增** | 前端提交前验证角色ID是否存在于本地数据库 |

### 4.3 前端页面变更

| 页面 | 变更说明 |
|------|---------|
| `NewAttribution.vue` | 表单结构重构（2级）、项目固定、截图必填、角色ID验证 |
| `UserManagement.vue` | 列表增加"组员编号"列 |
| `RoleList.vue` | 金额显示逻辑调整（由后端返回聚合值） |

---

## 5. 冲突与影响分析

### 5.1 变更间交叉影响

| 变更A | 变更B | 关系 | 处理策略 |
|-------|-------|------|----------|
| N1（用户架构） | P4（表单结构） | **依赖**：表单中"组名+组员编号"下拉选项依赖用户管理中的组和编号数据 | N1 必须先于 P4 完成 |
| N2（同步过滤） | P3（绑定判断） | **替代**：同步过滤取代了运行时 TA API 绑定检查 | 同一阶段处理，原 `checkBinding` 的 TA API 调用改为本地 DB 查询 |
| N2（同步过滤） | P7（列表过滤） | **协同**：同步过滤控制"入库"，审核状态控制"展示" | 同一阶段实现 `cpsVisible` 机制 |
| P1（金额修正） | P7（列表过滤） | **无冲突**：金额聚合逻辑独立于可见性过滤 | 可在同一阶段修改 |
| P4（表单结构） | P5（截图必填） | **无冲突**：均为 `NewAttribution.vue` 表单修改，不涉及相同字段 | 同一阶段修改 |
| P4（表单结构） | P6（项目固定） | **无冲突**：不涉及相同字段 | 同一阶段修改 |

### 5.2 对现有数据的影响

| 场景 | 影响 | 处理策略 |
|------|------|----------|
| 现有 `roles` 表中已有角色数据 | 新增 `cpsVisible` 默认为 `false`，所有现有角色在列表中不可见 | 若需保留已有角色可见性，需执行数据迁移脚本将已绑定CPS的角色设为 `visible` |
| 现有 `admin_users` 中已有用户 | 新增 `memberCode` 默认为 `NULL`，不影响现有用户登录和操作 | 管理员可手动补录编号，或通过迁移脚本批量生成 |
| 现有 `binding_applies` 中已有申请 | `platform` 字段语义变更（原为买量平台名 → 现为CPS组名） | 旧数据保留不变；新数据按新语义存储；前端展示时做兼容处理 |
| 角色同步 SQL 增加 `tf_medium` 过滤后 | 后续同步仅拉取满足条件的角色，不满足条件的角色不再被更新 | 不影响已入库数据；新增同步仅关注 CPS 候选角色 |

### 5.3 对现有功能的影响

| 功能 | 影响 | 处理策略 |
|------|------|----------|
| CPS 充值/登录日志同步 (`cps-sync.service.ts`) | **不受影响**——该模块已通过 CPS 维度表过滤，逻辑独立 | 无需修改 |
| Dashboard 统计 (`dashboard.service.ts`) | 需确认统计数据来源——若基于 `roles`/`orders` 表，统计口径可能受 `cpsVisible` 影响 | 仪表盘应统计所有数据（不受 `cpsVisible` 过滤），保留独立性 |
| 数据导出功能 | 角色/订单导出应与列表展示一致（仅导出可见数据） | 导出查询同步增加 `cpsVisible` 条件 |

---

## 6. 实施阶段规划

### Phase 1：数据库 Schema 变更（基础层）

**目标**：完成所有数据模型变更，为后续阶段提供基础。

#### 1.1 具体变更

**文件**：`suzaku-gaming-server/prisma/schema.prisma`

```diff
model AdminUser {
  // ... 现有字段 ...
+ memberCode   String?   @map("member_code") @db.VarChar(20) // 组员编号
  // ... 
}

model Role {
  // ... 现有字段 ...
+ cpsVisible     Boolean   @default(false) @map("cps_visible") // 列表可见性
  // ...
}
```

#### 1.2 实施步骤

| 步骤 | 操作 | 命令/文件 |
|------|------|-----------|
| 1 | 修改 `schema.prisma` 添加新字段 | `prisma/schema.prisma` |
| 2 | 生成迁移文件 | `npx prisma migrate dev --name add_member_code_and_cps_visible` |
| 3 | 验证迁移成功 | `npx prisma migrate status` |
| 4 | 重新生成 Prisma Client | `npx prisma generate` |

#### 1.3 测试用例

| 编号 | 测试项 | 预期结果 | 通过标准 |
|------|--------|----------|----------|
| T1.1 | 执行 `prisma migrate` | 迁移成功，无报错 | 命令返回成功 |
| T1.2 | 检查 `admin_users` 表结构 | 存在 `member_code` 列，允许 NULL | SQL 查询确认 |
| T1.3 | 检查 `roles` 表结构 | 存在 `cps_visible` 列，默认 `false` | SQL 查询确认 |
| T1.4 | 现有角色数据完整性 | 已有角色的 `cps_visible` 均为 `false` | SQL 查询确认 |
| T1.5 | 现有用户数据完整性 | 已有用户的 `member_code` 均为 `NULL` | SQL 查询确认 |
| T1.6 | 应用启动正常 | NestJS 服务正常启动，无报错 | 服务日志确认 |
| T1.7 | 现有 API 正常工作 | 角色列表、订单列表、用户列表接口正常返回 | HTTP 请求验证 |

**Phase 1 通过准则**：T1.1 ~ T1.7 全部通过。

---

### Phase 2：Seed 数据与用户管理改造

**目标**：建立初始组织架构（A/B/C 三组 + 组长账号），实现组员编号自动生成。

#### 2.1 具体变更

**文件清单**：

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `prisma/seed.ts` | 修改 | 创建 3 组组长，移除无关测试数据 |
| `src/modules/user/user.service.ts` | 修改 | `createUser()` 增加自动生成 `memberCode` |
| `src/modules/user/user.service.ts` | 修改 | `getTeamOptions()` 返回 `memberCode`、`cpsGroupCode` |
| `src/views/System/UserManagement.vue` | 修改 | 表格增加"组员编号"列 |

**Seed 数据结构**：

```typescript
// 初始账户
const accounts = [
  { username: 'admin',    role: 'admin',   level: 0, cpsGroupCode: null,     realName: '系统管理员' },
  { username: 'leader_a', role: 'manager', level: 1, cpsGroupCode: 'GroupA', realName: 'A组组长' },
  { username: 'leader_b', role: 'manager', level: 1, cpsGroupCode: 'GroupB', realName: 'B组组长' },
  { username: 'leader_c', role: 'manager', level: 1, cpsGroupCode: 'GroupC', realName: 'C组组长' },
];
```

**组员编号生成规则**：
- 格式：`{组前缀}-{三位序号}`，如 `A-001`、`B-002`
- 组前缀从 `cpsGroupCode` 提取（GroupA → A，GroupB → B，GroupC → C）
- 序号为该组内已有成员数 + 1，零填充到 3 位
- 生成时机：`user.service.ts` → `createUser()` 方法中，当角色为 `operator` 时自动生成

```typescript
// 自动生成组员编号（伪代码）
async generateMemberCode(cpsGroupCode: string): Promise<string> {
  const prefix = cpsGroupCode.replace('Group', ''); // 'GroupA' → 'A'
  const count = await this.prisma.adminUser.count({
    where: { cpsGroupCode, role: 'operator' }
  });
  const seq = String(count + 1).padStart(3, '0');
  return `${prefix}-${seq}`; // e.g. 'A-001'
}
```

#### 2.2 实施步骤

| 步骤 | 操作 | 文件 |
|------|------|------|
| 1 | 更新 `seed.ts` 创建初始组和组长 | `prisma/seed.ts` |
| 2 | 修改 `createUser()` 添加编号生成逻辑 | `src/modules/user/user.service.ts` |
| 3 | 修改 `getTeamOptions()` 增加返回字段 | `src/modules/user/user.service.ts` |
| 4 | 前端用户管理增加"组员编号"列 | `src/views/System/UserManagement.vue` |
| 5 | 执行 seed（仅开发环境或首次部署） | `npx prisma db seed` |

#### 2.3 测试用例

| 编号 | 测试项 | 操作 | 预期结果 |
|------|--------|------|----------|
| T2.1 | Seed 执行成功 | 执行 `npx prisma db seed` | 创建 admin + 3 个组长，无报错 |
| T2.2 | 管理员登录 | 使用 admin 账号登录 | 登录成功，角色为管理员 |
| T2.3 | 组长登录 | 使用 leader_a 账号登录 | 登录成功，角色为组长，所属组为 GroupA |
| T2.4 | 组长创建组员 | leader_a 创建一个组员 | 创建成功，自动分配编号 A-001 |
| T2.5 | 组员编号递增 | leader_a 再创建一个组员 | 编号为 A-002 |
| T2.6 | 跨组编号独立 | leader_b 创建一个组员 | 编号为 B-001（不受 A 组影响） |
| T2.7 | 组长权限隔离 | leader_a 尝试查看 B 组组员 | 不可见 / 返回空列表 |
| T2.8 | 管理员全局权限 | admin 查看所有用户 | 可见所有组的所有用户 |
| T2.9 | 管理员创建任意组账号 | admin 创建 A 组组员 | 创建成功，编号正确 |
| T2.10 | 前端组员编号展示 | 打开用户管理页面 | 表格中正确展示组员编号列 |
| T2.11 | `getTeamOptions` 返回值 | 调用接口 | 返回数据包含 `memberCode` 和 `cpsGroupCode` |

**Phase 2 通过准则**：T2.1 ~ T2.11 全部通过。

---

### Phase 3：数据同步逻辑改造（P1 + P3 + P7 部分 + N2 部分）

**目标**：修改 ThinkingData 数据同步策略——增加 `tf_medium` 过滤条件；新角色默认不可见；金额取自订单明细。

#### 3.1 具体变更

**文件清单**：

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `src/modules/thinkingdata/thinkingdata.service.ts` | 修改 | 角色同步 SQL 增加 `tf_medium` 过滤；新角色 `cpsVisible=false` |
| `src/modules/player/player.service.ts` | 修改 | `getRoles()` 金额改为从 orders 动态聚合 |
| `src/modules/cps/cps.service.ts` | 修改 | `checkBinding()` 改为本地 DB 查询（不再调用 TA API） |
| `src/modules/audit/audit.service.ts` | 修改 | `createBindingApply()` 增加角色ID验证 |
| `src/modules/audit/audit.controller.ts` | 新增接口 | `GET /audit/role-check/:roleId` 前端验证用 |

**角色同步 SQL 变更**：

```sql
-- 变更前 (buildRoleSyncSQL)
SELECT ... FROM ta.v_user_22 WHERE "create_role_id" IS NOT NULL

-- 变更后
SELECT ... FROM ta.v_user_22
WHERE "create_role_id" IS NOT NULL
  AND (
    "tf_medium" = 'Organic'
    OR "tf_medium" LIKE '%自然量%'
    OR "tf_medium" LIKE 'WA_CPS_link%'
  )
```

> **注意**：此过滤条件需同时应用到 `buildRoleSyncSQL`、`buildRoleSyncSQLNoLimit`、`buildRoleSyncSQLRange` 三个方法。

**新角色入库变更**：

```diff
// upsertRoles() 中的 create 数据
roleDataList.push({
  // ... 现有字段 ...
+ cpsVisible: false,  // 新角色默认不可见
});
```

**金额聚合变更**（`player.service.ts` → `getRoles()`）：

```diff
// 变更前：直接返回 role.totalRechargeUsd
totalRechargeUsd: Number(role.totalRechargeUsd),

// 变更后：从 orders 表动态聚合
// 在查询中增加 orders 聚合
select: {
  // ... 现有字段 ...
+ orders: {
+   where: { isSandbox: false },
+   select: { payAmountUsd: true }
+ }
},
// 返回时计算
totalRechargeUsd: role.orders.reduce(
  (sum, order) => sum + Number(order.payAmountUsd), 0
),
```

**角色验证接口**（新增 `GET /audit/role-check/:roleId`）：

```typescript
// audit.controller.ts
@Get('role-check/:roleId')
@Roles('admin', 'manager', 'operator')
async checkRoleExists(@Param('roleId') roleId: string) {
  const role = await this.prisma.role.findUnique({
    where: { roleId },
    select: { roleId: true, roleName: true, serverId: true, serverName: true, cpsGroup: true }
  });
  if (!role) {
    return { exists: false, message: '该角色不在CPS候选池中，无法绑定' };
  }
  if (role.cpsGroup) {
    return { exists: true, alreadyBound: true, message: `该角色已绑定到: ${role.cpsGroup}` };
  }
  return { exists: true, alreadyBound: false, role };
}
```

#### 3.2 实施步骤

| 步骤 | 操作 | 文件 |
|------|------|------|
| 1 | 修改 3 个角色同步 SQL 方法，增加 `tf_medium` 过滤 | `thinkingdata.service.ts` |
| 2 | 修改 `upsertRoles()`，新角色设 `cpsVisible=false` | `thinkingdata.service.ts` |
| 3 | 修改 `getRoles()` 金额聚合逻辑 | `player.service.ts` |
| 4 | 新增角色验证接口 | `audit.controller.ts` + `audit.service.ts` |
| 5 | 修改 `createBindingApply()` 增加角色验证 | `audit.service.ts` |
| 6 | 修改 `checkBinding()` 为本地查询 | `cps.service.ts` |

#### 3.3 测试用例

| 编号 | 测试项 | 操作 | 预期结果 |
|------|--------|------|----------|
| T3.1 | 同步 SQL 生成 | 检查生成的 SQL 字符串 | 包含 `tf_medium` 过滤条件 |
| T3.2 | 角色同步过滤 | 执行数据同步（含买量和自然量角色） | 仅自然量/Organic/WA_CPS_link 角色入库 |
| T3.3 | 新角色默认不可见 | 同步后查询角色表 | 新角色 `cps_visible = false` |
| T3.4 | 金额聚合正确性 | 查询一个有多笔订单的角色 | 返回金额 = 该角色所有非沙盒订单 `payAmountUsd` 之和 |
| T3.5 | 金额聚合-无订单 | 查询一个无订单的角色 | 返回金额 = 0 |
| T3.6 | 角色验证-存在 | `GET /audit/role-check/{有效roleId}` | 返回 `{ exists: true }` 及角色信息 |
| T3.7 | 角色验证-不存在 | `GET /audit/role-check/{无效roleId}` | 返回 `{ exists: false }` 及提示信息 |
| T3.8 | 角色验证-已绑定 | `GET /audit/role-check/{已绑定roleId}` | 返回 `{ exists: true, alreadyBound: true }` |
| T3.9 | 创建申请-无效角色 | 提交归因申请，角色ID不在本地DB | 返回 400 错误，提示角色不存在 |
| T3.10 | 创建申请-有效角色 | 提交归因申请，角色ID存在于本地DB | 创建成功 |
| T3.11 | 订单同步不受影响 | 执行订单同步 | 仅同步已存在角色的订单（现有逻辑已满足） |
| T3.12 | CPS日志同步不受影响 | 执行CPS充值/登录同步 | 正常运行，无报错 |

**Phase 3 通过准则**：T3.1 ~ T3.12 全部通过。

---

### Phase 4：归因申请表单重构（P4 + P5 + P6）

**目标**：重构归因修改申请页面——两级选择结构、项目固定、截图必填、角色ID前端验证。

#### 4.1 具体变更

**文件清单**：

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `src/views/Audit/NewAttribution.vue` | 重构 | 表单结构全面调整 |
| `src/api/audit.ts` | 修改 | 更新接口类型定义 |
| `src/api/user.ts` | 修改（如需）| `getTeamOptions` 返回结构适配 |

**表单结构变更**：

```
变更前（3级）：                    变更后（2级）：
┌─────────────────────┐           ┌─────────────────────┐
│ 项目选择 [下拉]      │           │ 项目    "海战" [只读] │
│ 角色ID  [输入]       │           │ 角色ID  [输入+验证]   │
│ 区服ID  [输入]       │           │ 区服ID  [输入]        │
│ 区服名称 [输入]      │           │ 区服名称 [输入]       │
│ 角色昵称 [输入]      │           │ 角色昵称 [输入]       │
│ ── 来源更改为 ──     │           │ ── 来源更改为 ──      │
│ 一级平台 [下拉]      │           │ 组名    [下拉]        │
│ 二级组长 [下拉]      │           │ 组员编号 [下拉]       │
│ 三级组员 [下拉]      │           │ ── 凭证 ──           │
│ 截图    [上传,可选]  │           │ 截图    [上传,必选3-5] │
│ 备注    [输入]       │           │ 备注    [输入]        │
└─────────────────────┘           └─────────────────────┘
```

**下拉数据来源**：

| 选项 | 数据来源 | 管理员 | 组长 | 组员 |
|------|---------|--------|------|------|
| 组名 | `AdminUser` 表中 `role='manager'` 的 `cpsGroupCode` 去重 | 可选所有组 | 锁定为本组 | 锁定为本组 |
| 组员编号 | `AdminUser` 表中 `role='operator'` 且 `cpsGroupCode=选中组` 的 `memberCode` | 选中组的所有编号 | 本组所有编号 | 本组所有编号 |

**角色ID 前端验证流程**：

```
用户输入角色ID → 失焦触发 → 调用 GET /audit/role-check/{roleId}
├── 不存在 → 显示错误提示"该角色不在CPS候选池中，无法绑定"，禁止提交
├── 已绑定 → 显示警告提示"该角色已绑定到{组名}"，禁止提交
└── 可绑定 → 自动填充区服ID、区服名称、角色昵称（如果接口返回了这些信息）
```

**截图校验规则**：

```typescript
// 提交前校验
const successCount = fileList.value.filter(f => f.status === 'success').length;
if (successCount < 3) {
  ElMessage.error('至少需要上传 3 张截图');
  return;
}
if (successCount > 5) {
  ElMessage.error('最多只能上传 5 张截图');
  return;
}
```

#### 4.2 实施步骤

| 步骤 | 操作 | 文件 |
|------|------|------|
| 1 | 修改表单数据结构（移除 `platform`/`teamLeader`/`teamMember`，改用 `cpsGroupName`/`memberCode`） | `NewAttribution.vue` |
| 2 | 项目字段固定为"海战"，改为只读展示 | `NewAttribution.vue` |
| 3 | 实现 2 级下拉联动（组名 → 组员编号） | `NewAttribution.vue` |
| 4 | 实现角色ID失焦验证（调用后端接口） | `NewAttribution.vue` |
| 5 | 截图必填校验（3-5张） | `NewAttribution.vue` |
| 6 | 更新 API 类型定义 | `src/api/audit.ts` |
| 7 | 数据隔离：根据当前用户角色限制可选组名 | `NewAttribution.vue` |

#### 4.3 测试用例

| 编号 | 测试项 | 操作 | 预期结果 |
|------|--------|------|----------|
| T4.1 | 项目字段只读 | 打开新建归因页面 | 项目显示"海战"，不可编辑 |
| T4.2 | 组名下拉-管理员 | 管理员打开表单 | 下拉显示所有组（A组、B组、C组） |
| T4.3 | 组名下拉-组长 | 组长打开表单 | 组名锁定为自己所在的组 |
| T4.4 | 组名下拉-组员 | 组员打开表单 | 组名锁定为自己所在的组 |
| T4.5 | 组员编号联动 | 选择 A 组 | 组员编号下拉显示 A 组所有已有编号 |
| T4.6 | 角色ID验证-有效 | 输入有效角色ID后失焦 | 通过验证，自动填充区服等信息 |
| T4.7 | 角色ID验证-无效 | 输入不存在的角色ID后失焦 | 显示错误提示，提交按钮禁用 |
| T4.8 | 角色ID验证-已绑定 | 输入已绑定的角色ID后失焦 | 显示警告，提交按钮禁用 |
| T4.9 | 截图-少于3张 | 上传2张截图后点击提交 | 提示"至少需要上传3张截图"，提交失败 |
| T4.10 | 截图-3张 | 上传3张截图后提交 | 提交成功 |
| T4.11 | 截图-5张 | 上传5张截图后提交 | 提交成功 |
| T4.12 | 截图-超过5张 | 尝试上传第6张 | 上传被拦截，提示"最多5张" |
| T4.13 | 完整提交流程 | 填写所有字段，上传3张截图，提交 | 成功创建申请记录 |
| T4.14 | 表单数据存储 | 查看数据库中新创建的申请 | `platform` 字段存储组名，`team_member` 存储组员编号 |

**Phase 4 通过准则**：T4.1 ~ T4.14 全部通过。

---

### Phase 5：审核联动与列表展示（P7 + N2 剩余部分）

**目标**：实现审核通过时联动角色可见性，角色列表和订单列表仅展示已通过审核的数据。

#### 5.1 具体变更

**文件清单**：

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `src/modules/audit/audit.service.ts` | 修改 | `reviewBindingApply()` 审核通过时设置 `cpsVisible=true` 及 `cpsGroup` |
| `src/modules/player/player.service.ts` | 修改 | `getRoles()` 增加 `cpsVisible: true` 过滤 |
| `src/modules/player/player.service.ts` | 修改 | `getOrders()` 增加关联角色的 `cpsVisible: true` 过滤 |
| `src/modules/player/player.service.ts` | 修改 | `exportRoles()` / `exportOrders()` 同步增加过滤 |

**审核通过联动逻辑**（`audit.service.ts` → `reviewBindingApply`）：

```typescript
// 审核通过时的联动操作（在事务中执行）
if (dto.action === 'approve') {
  // 1. 更新角色可见性和CPS分组
  await tx.role.update({
    where: { roleId: apply.roleId },
    data: {
      cpsVisible: true,
      cpsGroup: apply.platform,        // platform 字段现存储CPS组名
      cpsBindTime: new Date(),
      cpsBindBy: reviewerId,
    },
  });

  // 2. 记录 CPS 绑定记录（可选，视业务需要）
  // await tx.cpsBinding.create({ ... });
}
```

**角色列表过滤变更**（`player.service.ts` → `getRoles`）：

```diff
const where: any = {};
+ where.cpsVisible = true;  // 仅展示已通过审核的角色
// ... 其他筛选条件 ...
```

**订单列表过滤变更**（`player.service.ts` → `getOrders`）：

```diff
const where: any = {};
+ where.role = { cpsVisible: true };  // 仅展示已通过审核角色的订单
// ... 其他筛选条件 ...
```

#### 5.2 实施步骤

| 步骤 | 操作 | 文件 |
|------|------|------|
| 1 | 修改 `reviewBindingApply()` 增加联动逻辑 | `audit.service.ts` |
| 2 | 修改 `getRoles()` 增加可见性过滤 | `player.service.ts` |
| 3 | 修改 `getOrders()` 增加可见性过滤 | `player.service.ts` |
| 4 | 修改 `exportRoles()` 增加可见性过滤 | `player.service.ts` |
| 5 | 修改 `exportOrders()` 增加可见性过滤 | `player.service.ts` |
| 6 | 确认 Dashboard 统计不受影响 | `dashboard.service.ts` |

#### 5.3 测试用例

| 编号 | 测试项 | 操作 | 预期结果 |
|------|--------|------|----------|
| T5.1 | 角色列表-无审核通过 | 所有角色 `cpsVisible=false` 时访问角色列表 | 列表为空 |
| T5.2 | 审核通过联动 | 审核通过一个归因申请 | 对应角色 `cps_visible` 变为 `true`，`cps_group` 被设置 |
| T5.3 | 角色列表-有审核通过 | 审核通过后访问角色列表 | 仅显示已通过审核的角色 |
| T5.4 | 角色列表金额正确 | 查看已通过审核角色的金额列 | 金额 = 该角色所有非沙盒订单金额之和 |
| T5.5 | 订单列表过滤 | 访问订单列表 | 仅显示已通过审核角色的订单 |
| T5.6 | 审核拒绝无联动 | 拒绝一个归因申请 | 对应角色 `cps_visible` 保持 `false` |
| T5.7 | 导出角色-过滤 | 导出角色列表 CSV | CSV 仅包含已通过审核的角色 |
| T5.8 | 导出订单-过滤 | 导出订单列表 CSV | CSV 仅包含已通过审核角色的订单 |
| T5.9 | Dashboard 不受影响 | 查看 Dashboard 统计 | 统计数据正常（不受 `cpsVisible` 影响） |
| T5.10 | 角色列表分页正确 | 多个角色通过审核后翻页 | 总数和分页均正确 |
| T5.11 | 订单列表汇总金额 | 查看订单列表汇总 | 汇总金额仅统计已通过审核角色的订单 |
| T5.12 | 端到端流程 | 完整流程：同步→申请→审核→查看列表 | 数据正确流转，列表展示符合预期 |

**Phase 5 通过准则**：T5.1 ~ T5.12 全部通过。

---

## 7. 数据迁移与回滚策略

### 7.1 数据迁移脚本

若生产环境已有数据，需执行以下迁移操作：

```sql
-- 1. 为已有的、已绑定CPS的角色设置可见性
UPDATE roles
SET cps_visible = true
WHERE cps_group IS NOT NULL AND cps_group != '';

-- 2. 为已有组员生成编号（如果之前未分配）
-- 需按组分别执行，此处为示例
-- UPDATE admin_users SET member_code = 'A-001' WHERE id = ? AND role = 'operator';
```

### 7.2 回滚策略

每个 Phase 独立可回滚：

| Phase | 回滚方式 |
|-------|---------|
| Phase 1 | `prisma migrate rollback`（或手动 DROP COLUMN） |
| Phase 2 | 还原 `seed.ts` 和 `user.service.ts`，重新 seed |
| Phase 3 | 还原同步 SQL，移除 `tf_medium` 过滤和 `cpsVisible` 条件 |
| Phase 4 | 还原 `NewAttribution.vue` 到三级结构 |
| Phase 5 | 移除审核联动逻辑和列表过滤条件 |

### 7.3 注意事项

1. **先备份数据库**：在执行任何阶段前，确保已备份生产数据库。
2. **Seed 幂等性**：`seed.ts` 使用 `upsert` 操作，可安全重复执行。
3. **渐进部署**：每个 Phase 完成并测试通过后再部署到生产环境。
4. **CPS 同步服务**：`cps-sync.service.ts` 不在本次修改范围内，其已有的 CPS 维度表过滤逻辑保持不变。
5. **前端兼容**：`BindingApply.vue`（申请列表页）的详情弹窗需兼容新旧数据格式（旧数据可能有 `platform` 为 "iOS"/"Google" 等值）。

---

## 附录：参考 SQL

### A. 角色绑定判断过滤条件（用于数据同步）

```sql
SELECT "#account_id", "tf_medium" FROM ta.v_user_22
WHERE (
  tf_medium = 'Organic'
  OR tf_medium LIKE '%自然量%'
  OR tf_medium LIKE 'WA_CPS_link%'
)
```

### B. CPS 用户充值日志回传（已在 `cps-sync.service.ts` 中实现，无需修改）

```sql
SELECT
  "#account_id", "#event_time", "pay_amount_usd", "#country",
  "server_id", "role_name", "server_name", "publisher_order_id",
  "recharge_type", "#account_id@cps_group"
FROM (
  SELECT ... FROM v_event_22
  WHERE "$part_event" = 'recharge_complete'
    AND "recharge_type" = '现金'
    AND "is_sandbox" = '0'
    AND "$part_date" = '{date}'
    AND "#event_time" BETWEEN ... AND ...
) AS role_recharge
LEFT JOIN (
  SELECT "#account_id@account_id", "#account_id@cps_group"
  FROM ta_dim.dim_22_0_518509
) AS role_cps
ON role_recharge."#account_id" = role_cps."#account_id@account_id"
WHERE role_cps."#account_id@account_id" IS NOT NULL
```

### C. CPS 用户登录/登出日志（已在 `cps-sync.service.ts` 中实现，无需修改）

```sql
SELECT
  role_login."#account_id",
  "#event_time" AS "last_login_time",
  "#active_time" AS "create_time",
  "#country", "server_id", "role_name", "server_name",
  "#account_id@cps_group"
FROM (
  SELECT "#account_id", MAX("#event_time") AS "#event_time", ...
  FROM v_event_22
  WHERE "$part_event" = 'role_login' AND ...
  GROUP BY "#account_id", ...
) AS role_login
LEFT JOIN (SELECT "#account_id", "#active_time" FROM v_user_22) AS role_act
  ON role_login."#account_id" = role_act."#account_id"
LEFT JOIN (
  SELECT "#account_id@account_id", "#account_id@cps_group"
  FROM ta_dim.dim_22_0_518509
) AS role_cps
  ON role_login."#account_id" = role_cps."#account_id@account_id"
WHERE role_cps."#account_id@account_id" IS NOT NULL
```

---

> **文档结束** — 按 Phase 1 → 2 → 3 → 4 → 5 顺序执行，每阶段测试全部通过后进入下一阶段。
