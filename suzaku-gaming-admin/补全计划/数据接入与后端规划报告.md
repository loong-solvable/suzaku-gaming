# 数据接入与后端规划报告

## 1. 数据源概述

根据对 `suzaku-gaming-admin/example-raw-data` 目录下 CSV 文件的分析，我们确定了两个核心数据源，分别对应网站的 **玩家数据 (Player Data)** 和 **订单数据 (Order Data)** 板块。

| 文件名 | 对应板块 | 核心事件 | 数据内容 |
| :--- | :--- | :--- | :--- |
| `20260204_014715_06858_y9rrj.csv` | **角色列表 (Role List)** | `role_create` | 包含玩家的角色基础信息、设备信息、初始状态等。 |
| `20260204_014828_06863_y9rrj.csv` | **订单列表 (Order List)** | `recharge_complete` | 包含玩家的充值流水、购买商品、支付金额、支付渠道等。 |

---

## 2. 字段映射与需求分析

### 2.1 角色列表 (Role List)

该数据源对应后台的「玩家数据报表 - 角色列表」页面。

**✅ 需要保留的字段 (核心业务数据):**

| CSV 原始字段 | 目标系统字段 | 说明 |
| :--- | :--- | :--- |
| `role_id` | `roleId` | **主键**，角色唯一标识 |
| `role_name` | `roleName` | 角色昵称 |
| `server_name` / `server_id` | `serverName` / `serverId` | 所属服务器 |
| `role_level` | `level` | 角色等级 |
| `vip_level` | `vipLevel` | VIP等级 |
| `role_bp` | `combatPower` | 战力 (Battle Power) |
| `remain_diamond` | `diamond` | 剩余钻石余额 |
| `total_recharge_usd` | `totalRecharge` | 累计充值金额 (USD) |
| `faction_name` | `faction` | 所属阵营/公会 |
| `#event_time` | `createTime` | 角色创建时间 (基于 role_create 事件) |
| `#city` / `#country` | `region` | 玩家所属地区 |
| `#ip` | `lastLoginIp` | 注册/登录IP |

**❌ 不需要/建议丢弃的字段 (冗余或技术埋点):**

*   **SDK/埋点元数据**: `#lib`, `#lib_version`, `#data_source`, `#distinct_id`, `sdk_udid`, `sdk_open_id`, `sdk_adid`。
*   **设备详情**: `dev_model`, `dev_version`, `dev_type`, `steel_plant`, `screen_width` 等硬件参数（除非运营需要分析机型适配，否则后台管理列表不需要展示）。
*   **过度详细的游戏内部状态**: `missile_factory_lv`, `naval_academy_lv` 等具体的建筑等级（除非有详情页专门展示，否则列表页不需要加载这些）。

**⚠️ 去重与清洗策略:**
*   **去重**: 以 `role_id` 为唯一键。如果 CSV 中包含同一角色的多条记录（如多次登录更新），应取 `#event_time` 最近的一条作为该角色的最新状态。
*   **清洗**: 修正 `null` 或空字符串的字段；将金额字符串转换为浮点数；格式化时间戳。

### 2.2 订单列表 (Order List)

该数据源对应后台的「玩家数据报表 - 订单列表」页面。

**✅ 需要保留的字段 (核心交易数据):**

| CSV 原始字段 | 目标系统字段 | 说明 |
| :--- | :--- | :--- |
| `game_order_id` | `orderId` | **主键**，订单唯一标识 |
| `role_id` | `roleId` | 关联的角色ID |
| `role_name` | `roleName` | 角色昵称 (冗余存储，方便查询) |
| `pay_amount_usd` | `amount` | 支付金额 |
| `currency_type` | `currency` | 货币类型 (USD, JPY, etc.) |
| `goods_id` | `productId` | 商品ID |
| `order_confirm_time` | `payTime` | 订单支付时间 |
| `recharge_channel` | `channel` | 支付渠道 (AppStore, GooglePlay等) |
| `server_name` | `serverName` | 服务器 |
| `is_sandbox` | `isSandbox` | 是否沙箱/测试订单 |

**❌ 不需要/建议丢弃的字段:**

*   **复杂JSON结构**: `captain_bag`, `ship_info`, `strategicweapon_info` 等。这些是充值时的玩家背包快照，对于财务对账和订单查询通常不需要，除非用于客诉排查（建议存入单独的 NoSQL 归档表或仅保留关键摘要）。
*   **SDK元数据**: 同上，大量的 `#lib` 和设备信息。

**⚠️ 去重与清洗策略:**
*   **去重**: 以 `game_order_id` 为唯一键。
*   **清洗**: 确保金额精度正确；将 `order_confirm_time` 统一转换为系统时区时间。

---

## 3. 数据接入方案

### 3.1 接入流程 (ETL)

建议编写一个 **Python** 或 **Node.js** 脚本执行以下步骤：

1.  **Extract (抽取)**: 读取 CSV 文件。
2.  **Transform (转换)**:
    *   过滤掉不需要的列（Drop Columns）。
    *   重命名字段以匹配数据库 Schema。
    *   类型转换（String -> DateTime, String -> Decimal）。
    *   **数据关联**: 在处理订单数据时，如果发现 `role_id` 在角色表中不存在，可以先创建一个“占位”角色或记录日志。
3.  **Load (加载)**: 将清洗后的数据批量写入数据库。

### 3.2 自动化建议
*   由于文件名包含时间戳 (`20260204_...`)，脚本应设计为支持增量读取（只读取新文件）。
*   可以将 CSV 文件上传到对象存储（如 S3/OSS），触发云函数自动解析入库。

---

## 4. 后端设计规划

为了支撑 `Suzaku Gaming` 后台管理系统，建议采用 **关系型数据库 (PostgreSQL 或 MySQL)**。

### 4.1 数据库模型 (ERD 简述)

#### 表 1: `players` (玩家表)
*   **id**: BIGINT (PK, 对应 `role_id`)
*   **nickname**: VARCHAR
*   **server_id**: VARCHAR
*   **level**: INT
*   **vip_level**: INT
*   **total_recharge**: DECIMAL(10, 2)
*   **diamond_balance**: INT
*   **region**: VARCHAR
*   **register_time**: DATETIME
*   **last_login_time**: DATETIME
*   **status**: SMALLINT (0:正常, 1:封禁)

#### 表 2: `orders` (订单表)
*   **id**: VARCHAR (PK, 对应 `game_order_id`)
*   **player_id**: BIGINT (FK -> players.id)
*   **amount**: DECIMAL(10, 2)
*   **currency**: VARCHAR(10)
*   **product_id**: VARCHAR
*   **channel**: VARCHAR
*   **pay_time**: DATETIME
*   **status**: SMALLINT (0:待支付, 1:成功, 2:失败)

### 4.2 API 接口设计

为了对接前端 Mock 接口，后端应提供以下 RESTful API：

1.  **获取角色列表**
    *   `GET /api/players`
    *   Parameters: `page`, `pageSize`, `keyword` (搜索昵称/ID), `server`, `level_min`, `level_max`.
    *   Response: `{ total: 100, list: [...] }`

2.  **获取订单列表**
    *   `GET /api/orders`
    *   Parameters: `page`, `pageSize`, `player_id`, `date_range`, `status`.

3.  **角色详情**
    *   `GET /api/players/{id}`
    *   Response: 包含基础信息及该玩家的最近订单统计。

4.  **数据统计 (Dashboard)**
    *   `GET /api/dashboard/stats`
    *   计算逻辑: 聚合 `orders` 表计算今日收入 (`SUM(amount)` where `pay_time` = today)，聚合 `players` 表计算新增用户。

## 5. 总结

当前的两个 CSV 文件非常契合后台系统的核心需求。
*   **`...06858...csv`** 是 **用户库** 的基础。
*   **`...06863...csv`** 是 **财务库** 的基础。

通过建立上述的数据库结构，并编写简单的导入脚本，即可将静态的 CSV 数据转化为动态的后台管理系统数据源，完美替代前端的 Mock 数据。
