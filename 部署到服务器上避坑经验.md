# 朱雀游戏后台 - 服务器部署避坑经验

> 本文档记录了将项目从 GitHub 部署到 Linux 服务器过程中遇到的所有问题及解决方案。

## 目录

1. [环境信息](#环境信息)
2. [问题一：根目录磁盘空间不足](#问题一根目录磁盘空间不足)
3. [问题二：ThinkingData 数据同步未配置](#问题二thinkingdata-数据同步未配置)
4. [问题三：无法在容器内运行同步脚本](#问题三无法在容器内运行同步脚本)
5. [问题四：上传的图片无法显示](#问题四上传的图片无法显示)
6. [问题五：Docker 权限问题](#问题五docker-权限问题)
7. [问题六：时区显示问题](#问题六时区显示问题)
8. [部署检查清单](#部署检查清单)

---

## 环境信息

- **服务器操作系统**：CentOS 7
- **磁盘分区**：
  - 根目录 `/`：19GB（部署前已用 93%）
  - 数据目录 `/data`：197GB（可用 186GB）
- **部署方式**：Docker Compose

---

## 问题一：根目录磁盘空间不足

### 问题表现

部署完成后，根目录空间告急：

```
Filesystem               Size  Used Avail Use% Mounted on
/dev/mapper/centos-root   19G   18G  1.5G  93% /
/dev/nvme1n1             197G  257M  187G   1% /data
```

### 原因分析

Docker 默认将所有数据（镜像、容器、卷）存储在 `/var/lib/docker` 目录下，该目录位于根分区。随着镜像构建和容器运行，根目录空间被大量占用。

### 解决方案

将 Docker 数据目录迁移到空间充足的 `/data` 分区。

**操作步骤：**

```bash
# 1. 停止所有容器和 Docker 服务
cd /data/suzaku/suzaku-gaming
sudo docker-compose down
sudo systemctl stop docker

# 2. 创建新的 Docker 数据目录
sudo mkdir -p /data/docker

# 3. 复制现有数据到新目录
sudo rsync -aP /var/lib/docker/ /data/docker/

# 4. 修改 Docker 配置，添加 data-root
sudo vi /etc/docker/daemon.json
```

配置文件内容：

```json
{
    "data-root": "/data/docker",
    "registry-mirrors": [
        "https://mirror.ccs.tencentyun.com",
        "https://docker.mirrors.ustc.edu.cn",
        "https://registry.docker-cn.com"
    ],
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "100m",
        "max-file": "3"
    }
}
```

```bash
# 5. 启动 Docker 并验证
sudo systemctl start docker
sudo docker info | grep "Docker Root Dir"
# 应显示：Docker Root Dir: /data/docker

# 6. 启动项目服务
cd /data/suzaku/suzaku-gaming
sudo docker-compose up -d

# 7. 确认服务正常后，删除旧数据释放空间
sudo rm -rf /var/lib/docker
```

### 效果

```
# 迁移前
/dev/mapper/centos-root   19G   18G  1.5G  93% /

# 迁移后
/dev/mapper/centos-root   19G  2.8G   17G  15% /
```

---

## 问题二：ThinkingData 数据同步未配置

### 问题表现

前端页面只显示 3 条测试数据（来自 seed.ts 的假数据），没有真实的游戏数据。

查看后端日志发现：
```
[ThinkingDataScheduler] Sync skipped: TA_SYNC_ENABLED is false
```

### 原因分析

`.env.production` 中 ThinkingData 相关配置未正确设置：

```bash
TA_API_HOST=          # 空
TA_PROJECT_TOKEN=     # 空
TA_SYNC_ENABLED=false # 未启用
```

### 解决方案

**1. 编辑配置文件：**

```bash
sudo vi /data/suzaku/suzaku-gaming/.env.production
```

修改为：

```bash
TA_API_HOST=https://ss-search.tapplus.com:18993/querySql
TA_PROJECT_TOKEN=你的项目Token
TA_SYNC_ENABLED=true
```

**2. 重启后端使配置生效：**

```bash
cd /data/suzaku/suzaku-gaming
sudo docker-compose restart backend
```

**3. 验证配置：**

```bash
sudo docker exec suzaku-backend printenv | grep TA_
```

---

## 问题三：无法在容器内运行同步脚本

### 问题表现

尝试在容器内运行同步脚本报错：

```bash
sudo docker exec -it suzaku-backend npx ts-node scripts/sync-week.ts

# 报错：Error: Cannot find module './sync-week.ts'
```

### 原因分析

查看 Dockerfile 发现，生产镜像只复制了 `dist`、`node_modules`、`package.json` 和 `prisma` 目录，**没有复制 scripts 目录**。这是为了减小镜像体积。

```dockerfile
# Stage 2: Production
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
COPY --from=builder /app/prisma ./prisma
# scripts 目录未复制
```

### 解决方案

通过 **API 调用** 来触发数据同步，无需运行脚本。

**一键同步脚本：**

```bash
# 获取登录 Token
TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | sed -n 's/.*"token":"\([^"]*\)".*/\1/p')

# 计算日期范围
START_DATE=$(date -d "7 days ago" +%Y-%m-%d)
END_DATE=$(date +%Y-%m-%d)

echo "同步日期范围: $START_DATE 至 $END_DATE"

# 1. 同步角色数据
echo "[1/3] 同步角色数据..."
curl -s -X POST "http://localhost:3000/api/sync/thinkingdata/sync-roles?limit=100000" \
  -H "Authorization: Bearer $TOKEN"

# 2. 同步订单数据
echo "[2/3] 同步订单数据..."
curl -s -X POST "http://localhost:3000/api/sync/thinkingdata/sync-orders-range?startDate=$START_DATE&endDate=$END_DATE&limit=100000" \
  -H "Authorization: Bearer $TOKEN"

# 3. 同步最后登录时间
echo "[3/3] 同步最后登录时间..."
curl -s -X POST "http://localhost:3000/api/sync/thinkingdata/sync-last-login-range?startDate=$START_DATE&endDate=$END_DATE" \
  -H "Authorization: Bearer $TOKEN"

echo "同步完成！"
```

**验证同步结果：**

```bash
sudo docker exec suzaku-postgres psql -U suzaku -d suzaku_gaming -c \
  "SELECT 'roles' as table_name, COUNT(*) as count FROM roles 
   UNION ALL SELECT 'orders', COUNT(*) FROM orders 
   UNION ALL SELECT 'sync_logs', COUNT(*) FROM sync_logs;"
```

---

## 问题四：上传的图片无法显示

### 问题表现

用户上传了 3 张图片作为归因申请的附件：
- `.webp` 图片 → **能正常显示**
- `.png` 图片 → **404 Not Found**
- `.jpg` 图片 → **404 Not Found**

### 原因分析

**问题 1**：Nginx 配置中缺少 `/uploads/` 路径的代理配置。

**问题 2**：即使添加了 `/uploads/` 代理，Nginx 有一个静态文件缓存规则：

```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

这个正则规则匹配了 `.png`、`.jpg` 等后缀，**优先级高于** `/uploads/` 的普通前缀匹配。所以：

- `.webp` 不在正则规则中 → 走 `/uploads/` 代理 → 成功
- `.png`、`.jpg` 被正则规则匹配 → 在前端容器找不到文件 → 404

### 解决方案

修改 `suzaku-gaming-admin/nginx.conf`，添加 `/uploads/` 代理配置并使用 `^~` 前缀提高优先级：

```nginx
# API proxy
location /api/ {
    proxy_pass http://backend:3000;
    # ... 其他配置
}

# 上传文件代理（必须使用 ^~ 确保优先级高于静态文件正则规则）
location ^~ /uploads/ {
    proxy_pass http://backend:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# 静态文件缓存（仅用于前端资源）
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

**关键点**：`^~` 前缀会让该规则优先于正则匹配（`~*`）。

**已部署服务的临时修复：**

```bash
# 1. 创建新的 nginx 配置文件
cat > /tmp/nginx.conf << 'EOF'
# ... 完整的 nginx.conf 内容（包含 ^~ /uploads/ 配置）
EOF

# 2. 复制到容器并重载
sudo docker cp /tmp/nginx.conf suzaku-frontend:/etc/nginx/nginx.conf
sudo docker exec suzaku-frontend nginx -s reload
```

---

## 问题五：Docker 权限问题

### 问题表现

普通用户执行 docker 命令报错：

```
Got permission denied while trying to connect to the Docker daemon socket
```

### 原因分析

Docker 守护进程绑定到 Unix socket，默认只有 root 用户或 docker 组成员才能访问。

### 解决方案

**方案一：使用 sudo（推荐）**

```bash
sudo docker ps
sudo docker-compose up -d
```

**方案二：将用户加入 docker 组**

```bash
sudo usermod -aG docker $USER
# 需要重新登录生效
```

---

## 问题六：时区显示问题

### 问题表现

用户反馈"现在是晚上 8 点，为什么日志显示 12:00 PM？"

### 原因分析

Docker 容器默认使用 UTC 时区，而定时任务配置了 `Asia/Shanghai` 时区：

```typescript
@Cron('0 */30 * * * *', {
  timeZone: 'Asia/Shanghai',
})
```

所以：
- 定时任务按**北京时间**执行（正确）
- 日志显示**UTC 时间**（视觉上差 8 小时）

### 解决方案

这不是问题，定时任务实际上在正确的时间执行。如果需要日志显示北京时间，可以在 docker-compose.yml 中添加时区配置：

```yaml
backend:
  environment:
    - TZ=Asia/Shanghai
```

---

## 部署检查清单

部署新服务器时，按以下清单检查：

### 部署前

- [ ] 检查磁盘空间，确认 `/data` 或其他大容量分区可用
- [ ] 准备好 ThinkingData 的 API Host 和 Project Token

### 部署中

- [ ] 配置 Docker 数据目录到大容量分区（修改 `/etc/docker/daemon.json`）
- [ ] 配置 `.env.production`：
  - [ ] 修改数据库密码
  - [ ] 修改 JWT 密钥
  - [ ] 配置 ThinkingData（如需同步数据）

### 部署后

- [ ] 验证所有容器运行正常：`sudo docker ps`
- [ ] 验证数据库连接正常：`sudo docker exec suzaku-postgres psql -U suzaku -d suzaku_gaming -c "SELECT 1"`
- [ ] 验证 ThinkingData 配置：`sudo docker exec suzaku-backend printenv | grep TA_`
- [ ] 测试图片上传功能是否正常
- [ ] 测试数据同步是否正常
- [ ] 检查磁盘空间：`df -h`

### 常用命令速查

```bash
# 查看服务状态
sudo docker ps

# 查看后端日志
sudo docker logs suzaku-backend --tail 100

# 查看数据库数据量
sudo docker exec suzaku-postgres psql -U suzaku -d suzaku_gaming -c \
  "SELECT 'roles', COUNT(*) FROM roles UNION ALL SELECT 'orders', COUNT(*) FROM orders;"

# 重启服务
cd /data/suzaku/suzaku-gaming
sudo docker-compose restart

# 重新部署
sudo docker-compose down
sudo docker-compose build --no-cache
sudo docker-compose up -d
```

---

## 总结

| 问题 | 根本原因 | 解决方案 |
|------|----------|----------|
| 磁盘空间不足 | Docker 数据在根目录 | 迁移到 /data 分区 |
| 无真实数据 | ThinkingData 未配置 | 配置环境变量并启用 |
| 脚本无法运行 | 镜像未包含 scripts | 通过 API 调用同步 |
| 图片 404 | Nginx 缺少代理配置 | 添加 ^~ /uploads/ 规则 |
| Docker 权限 | 用户不在 docker 组 | 使用 sudo |

---

*文档生成时间：2026-02-05*
